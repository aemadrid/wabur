#!/usr/bin/env ruby
# encoding: UTF-8

while (index = ARGV.index('-I'))
  _, path = ARGV.slice!(index, 2)
  $: << path
end

require 'optparse'

require 'wab'
require 'wab/impl'

cfg = {
  'handler.path' => '/v1',
  'type_key' => 'kind',
  'http.dir' => '.',
  'controller' => 'BasicController',
  'http.port' => 6363,
  'verbose' => false
}
cfg_file = nil

opts = OptionParser.new(%{Usage: wabur [options]

A WAB Runner that is configured with a unix style conf file.
})
opts.on('-v', 'verbose')                                     { cfg['verbose'] = true }
opts.on('-c', '--conf String', String, 'configuration file') { |c| cfg_file = c }
opts.on('-h', '--help', 'Show this display')                 { puts opts.help; Process.exit!(0) }
opts.parse(ARGV)

class BasicController < ::WAB::Controller

  def initialize(shell, async=false)
    super(shell, async)
  end

  def handle(data)
    super
  end

  def create(path, query, data, rid=nil)
    super
  end

  def read(path, query, rid=nil)
    super
  end

  def update(path, query, data, rid=nil)
    super
  end

  def delete(path, query, rid=nil)
    super
  end

  def on_result(data)
    super
  end

end # BasicController

unless cfg_file.nil?
  File.open(File.expand_path(cfg_file)) { |f|
    f.each_line() { |line|
      line.strip!
      next if 0 == line.length || '#' == line[0]
      k, v = line.split('=')
      cfg[k.strip] = v.strip
    }
  }
end

shell = ::WAB::Impl::Shell.new(cfg)
controller = Object.const_get(cfg['controller']).new(shell, false)
shell.register_controller(nil, controller)
puts "*** starting #{shell}"
shell.start()
